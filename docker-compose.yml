services:
  server:
    image: node:20-alpine
    working_dir: /opt/clawchat
    command: >-
      sh -c "corepack enable && pnpm install &&
      if [ \"$$RUN_FAKE_AGENT\" = 'true' ]; then (pnpm --filter @clawchat/fake-agent dev &); fi &&
      pnpm --filter @clawchat/server dev"
    environment:
      - RUN_FAKE_AGENT=${RUN_FAKE_AGENT:-false}
    ports:
      - "3100:3100"
      - "3101:3101"
    volumes:
      - .:/opt/clawchat
      - ../eliezer:/opt/eliezer
      - server_store:/opt/clawchat/.pnpm-store
      - server_root_modules:/opt/clawchat/node_modules
      - server_modules:/opt/clawchat/server/node_modules

  client:
    image: node:20-alpine
    working_dir: /opt/clawchat
    command: sh -c "corepack enable && pnpm install && pnpm --filter @clawchat/client dev --host"
    environment:
      - API_URL=http://server:3101
    ports:
      - "3102:3102"
    volumes:
      - .:/opt/clawchat
      - client_store:/opt/clawchat/.pnpm-store
      - client_root_modules:/opt/clawchat/node_modules
      - client_modules:/opt/clawchat/client/node_modules
    depends_on:
      - server

  widgets:
    image: node:22-alpine
    working_dir: /opt/clawchat
    command: sh -c "corepack enable && pnpm install && node --watch widget-server/src/index.ts"
    ports:
      - "3103:3103"
    volumes:
      - .:/opt/clawchat
      - widgets_store:/opt/clawchat/.pnpm-store
      - widgets_root_modules:/opt/clawchat/node_modules
      - widgets_modules:/opt/clawchat/widget-server/node_modules

volumes:
  server_store:
  server_root_modules:
  server_modules:
  client_store:
  client_root_modules:
  client_modules:
  widgets_store:
  widgets_root_modules:
  widgets_modules:
